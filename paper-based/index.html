<!DOCTYPE html>
<html>
<head>
<script type="text/javascript" src="jquery-1.7.2.js"></script>
<script type="text/javascript" src="paperjs-v0.9.15/dist/paper.js"></script>
<!-- Define inlined JavaScript -->
<script type="text/javascript">

        roiStyle = {
            strokeColor: 'black',
            fillColor: 'rgba(255, 0, 0, 0.2)'
        };

        var loadROIs = function() {
            var test = new paper.Path.Rectangle(200, 200, 100, 100);
            test.style = roiStyle;

            var test2 = new paper.Path.Ellipse(50, 100, 100, 50);
            test2.style = roiStyle;

            return new paper.Group([test, test2]);
        };


	$(document).ready(function() {
            // Get a reference to the canvas object
            var canvas = document.getElementById('myCanvas');
            // Create an empty project and a view for the canvas:
            paper.setup(canvas);

            var image = new paper.Raster("image");
            image.translate(image.width / 2, image.height / 2);

            var roiGroup = loadROIs();

            var moveAndCheckBounds = function(delta) {
                var bounds = paper.project.activeLayer.bounds.clone();
                delta.x = Math.max(delta.x, paper.view.bounds.width - bounds.width - bounds.x);
                delta.y = Math.max(delta.y, paper.view.bounds.height - bounds.height - bounds.y);
                delta.x = Math.min(delta.x, paper.view.bounds.x - bounds.x);
                delta.y = Math.min(delta.y, paper.view.bounds.y - bounds.y);
                paper.project.activeLayer.translate(delta);
            };

            var modes = ['topLeft', 'topCenter', 'topRight', 'leftCenter', 'rightCenter', 'bottomLeft', 'bottomCenter', 'bottomRight'];

            var selectBox = null;
            var selectedItem;
            var handlesGroup;
            var handles;

            var updateHandles = function() {
                for (var i in modes) {
                    handles[i].position = selectBox.bounds[modes[i]];
                }
            };

            var selectItem = function(item) {
                if (selectBox) {
                    selectBox.remove();
                }
                if (item) {
                    selectBox = new paper.Path.Rectangle(item.strokeBounds);
                    selectBox.style = {
                        strokeColor: 'yellow'
                    }
                    if (!handlesGroup) {
                        handles = [];
                        for (var i in modes) {
                            var p = selectBox.bounds[modes[i]];
                            handles.push(new paper.Path.Rectangle(p.x - 5, p.y - 5, 11, 11));
                        }
                        handlesGroup = new paper.Group(handles);
                        handlesGroup.style = {
                            strokeColor: 'black',
                            fillColor: 'white'
                        };
                    } else {
                        paper.project.activeLayer.addChild(handlesGroup);
                        updateHandles();
                    }
                } else {
                    handlesGroup.remove();
                }
                selectedItem = item;
            }

            var resizeOptions = {
                topLeft: ['bottomRight', -1, -1],
                topCenter: ['bottomCenter', 0, -1],
                topRight: ['bottomLeft', 1, -1],
                leftCenter: ['rightCenter', -1, 0],
                rightCenter: ['leftCenter', 1, 0],
                bottomLeft: ['topRight', -1, 1],
                bottomCenter: ['topCenter', 0, 1],
                bottomRight: ['topLeft', 1, 1]
            };

            var lastHit;

            var dragging = false;
            var mode = null;
            var resizeMode;

            var defaultTool = new paper.Tool({
                'onMouseDrag': function(event) {
                    dragging = true;
                    if (mode == 'pan') {
                        moveAndCheckBounds(event.delta.clone());
                    } else if (mode == 'dragShape') {
                        selectedItem.position.x += event.delta.x;
                        selectedItem.position.y += event.delta.y;
                        selectBox.position = selectedItem.position;
                        updateHandles();
                    } else if (mode == 'resize') {

                        var options = resizeOptions[resizeMode];

                        var b = selectedItem.bounds;
                        var new_width = Math.max(b.width + event.delta.x * options[1], 10);
                        var new_height = Math.max(b.height + event.delta.y * options[2], 10);
                        selectedItem.scale(new_width / b.width, new_height / b.height, selectedItem.bounds[options[0]]);
                        selectBox.scale(new_width / b.width, new_height / b.height, selectBox.bounds[options[0]]);
                        updateHandles();
                    }
                },
                'onMouseMove': function(event) {
                    var hit = roiGroup.hitTest(event.point, {'tolerance': 10, 'fill': true});
                    if (lastHit) {
                        lastHit.item.strokeColor = 'black';
                    }
                    if (hit) {
                        hit.item.strokeColor = 'green';
                    }
                    lastHit = hit;
                },
                'onMouseDown': function(event) {
                    dragging = false;
                    if (handles) {
                        for (var i in modes) {
                            if (handles[i].hitTest(event.point, {'fill': true})) {
                                mode = 'resize';
                                resizeMode = modes[i];
                                return;
                            }
                        }
                    }
                    if (lastHit) {
                        selectItem(lastHit.item);
                        mode = 'dragShape';
                    } else {
                        mode = 'pan';
                    }
                },
                'onMouseUp': function(event) {
                    if (!dragging && !lastHit) {
                        selectItem(null);
                    }
                }
            });

            var zoom = function(level, x, y, delta) {
                if (!level && delta < 0) {
                    level = paper.view.zoom * 1.1;
                } else if (!level && delta > 0) {
                    level = paper.view.zoom / 1.1;
                }
                if (level) {
                    // get coordinates under mouse before and after zoom...
                    var before = paper.view.viewToProject(x, y);
                    paper.view.zoom = level;
                    // ...then scroll to keep the same point under the mouse
                    moveAndCheckBounds(paper.view.viewToProject(x, y).subtract(before));
                    paper.view.draw();
                    $("#zoom-tool").val(parseInt(level * 100, 10));
                }
            };


            // hook up event handlers

            paper.view.element.addEventListener('mousewheel', function(ev) {
                zoom(undefined, ev.pageX, ev.pageY, -ev.wheelDelta);
            }, false);
            paper.view.element.addEventListener('DOMMouseScroll', function(ev) {
                zoom(undefined, ev.pageX, ev.pageY, ev.detail);
            }, false);

            $("#toggle-rois").click(function() {
                roiGroup.visible = !roiGroup.visible;
                selectItem(null);
                paper.view.draw(); // draw immediately
            });

            $("#panning-tool").click(function() {
                defaultTool.activate();
            });
            defaultTool.activate();

            $("#zoom-tool").on('change', function(event) {
                zoom(parseFloat(this.value, 10) / 100);
            });
        });
</script>
</head>
<body>
	<canvas id="myCanvas" style="width: 600px; height: 400px; border: solid red 1px;"></canvas>

        <br /><br /><br />

        <button id="toggle-rois">Toggle ROIs</button>
        <button id="panning-tool">Pan</button>
        Zoom: <input type="number" min="0" max="1000" id="zoom-tool" value="100" step="10" />

        <img src="sample.jpg" style="display: none;" id="image" />

        <img src="sample.jpg" style="width: 200px; height: 200px;" />
</body>
</html>
